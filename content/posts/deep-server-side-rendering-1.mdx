---
title: æ·±å…¥æœåŠ¡ç«¯æ¸²æŸ“ï¼ˆä¸‹ï¼‰
topic: content/topics/react.mdx
date: 2024-12-11T16:00:00.000Z
draft: false
---

ä½ å¯ä»¥é˜…è¯»ä¸‹é¢çš„å†…å®¹äº†è§£åŒæ„æ¸²æŸ“çš„å®ç°ï¼Œä¹Ÿå¯ä»¥ç›´æ¥è·³åˆ°[è¿™é‡Œ](https://github.com/985563349/vite-ssr/tree/main)æŸ¥çœ‹å®Œæ•´ä»£ç ã€‚

### æ¸²æŸ“

ä¼ ç»ŸæœåŠ¡ç«¯æ¸²æŸ“é€šå¸¸ä¼šä½¿ç”¨ PHP æˆ–è€… Java ç­‰è¯­è¨€è¿›è¡Œå¼€å‘ï¼Œè€ŒåŒæ„æ¸²æŸ“æˆ‘ä»¬ä¸€èˆ¬ä¼šä½¿ç”¨ Node.JS æ¥å¼€å‘æœåŠ¡ç«¯çš„éƒ¨åˆ†ã€‚

å®¢æˆ·ç«¯æ¸²æŸ“çš„éƒ¨åˆ†æˆ‘ä»¬å°†ä½¿ç”¨ Reactï¼Œå¹¶é€šè¿‡ Vite æ¥ç¼–è¯‘ JSX è¯­æ³•ã€‚æœ€åï¼ŒåŒ…ç®¡ç†å™¨æˆ‘ä»¬ä½¿ç”¨ pnpm ã€‚

é¦–å…ˆï¼Œåˆ›å»ºä¸€ä¸ªé¡¹ç›®ç›®å½•ï¼Œå¹¶åˆå§‹åŒ– pnpmï¼š

```bash
mkdir vite-ssr
cd vite-ssr
pnpm init
```

å®‰è£…é¡¹ç›®æ‰€éœ€è¦çš„ä¾èµ–ï¼š

```bash
pnpm add react react-dom express

pnpm add vite @vitejs/plugin-react -D
```

æ¥ç€ï¼Œåœ¨é¡¹ç›®æ ¹ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ª index.html æ–‡ä»¶ï¼Œå¹¶æ·»åŠ ä»¥ä¸‹ä»£ç ï¼š

```html
<!-- title index.html-->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Vite SSR</title>
  </head>
  <body>
    <div id="app"><!--app-html--></div>
  </body>
</html>
```

æ³¨æ„ï¼Œæˆ‘ä»¬åœ¨ HTML ä¸­æ·»åŠ äº†ä¸€ä¸ªæ³¨é‡ŠèŠ‚ç‚¹ï¼Œä¹‹åæˆ‘ä»¬ä¼šåœ¨æœåŠ¡ç«¯æ¸²æŸ“æ—¶ä½¿ç”¨é¡µé¢å†…å®¹æ›¿æ¢å®ƒã€‚

æ¥ç€ï¼Œåˆ›å»ºä¸€ä¸ª server.js æ–‡ä»¶ï¼š

```js
// title server.js
import fs from 'node:fs/promises';
import express from 'express';

const app = express();

app.use('*', async (req, res) => {
  const html = await fs.readFile('./index.html', 'utf-8');

  res.status(200).set({ 'Content-Type': 'text/html' }).send(html);
});

app.listen(3000, () => {
  console.log('Server is running on http://localhost:3000');
});
```

æˆ‘ä»¬ä½¿ç”¨ express åˆ›å»ºäº†ä¸€ä¸ª HTTP æœåŠ¡ï¼Œå¹¶ç›‘å¬ 3000 ç«¯å£ã€‚

æ¥ç€ï¼Œæˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹ package.json æ–‡ä»¶ï¼Œå¹¶æ·»åŠ ä¸€ä¸ª dev å‘½ä»¤ï¼š

```json
// title package.json
{
  "name": "vite-ssr",
  "private": true,
  "version": "0.0.1",
  "type": "module",
  "scripts": {
    "dev": "node server"
  },
  "dependencies": {
    "express": "^4.21.2",
    "react": "^19.0.0",
    "react-dom": "^19.0.0"
  },
  "devDependencies": {
    "@vitejs/plugin-react": "^4.3.4",
    "vite": "^6.0.3"
  }
}
```

æ³¨æ„ï¼Œä¸€å®šè¦å°† type è®¾ç½®ä¸º moduleï¼Œå¦åˆ™åœ¨ node ç¯å¢ƒä¸­å°†æ— æ³•ä½¿ç”¨ import è¯­æ³•ã€‚

ç°åœ¨ï¼Œä½ å¯ä»¥é€šè¿‡ pnpm dev å¯åŠ¨é¡¹ç›®ï¼Œè®¿é—® [http://localhost:3000](http://localhost:3000) æ¥æŸ¥çœ‹æ•ˆæœã€‚ç›®å‰é¡µé¢æ˜¯ç©ºç™½çš„ï¼Œå› ä¸ºæˆ‘ä»¬è¿˜æ²¡æœ‰æ·»åŠ ä»»ä½•å†…å®¹ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ª React ç»„ä»¶å¹¶åœ¨æœåŠ¡ç«¯æ¸²æŸ“å®ƒï¼Œå¾ˆå¿«ä½ å°±èƒ½çœ‹åˆ°é¡µé¢å†…å®¹äº†ã€‚

é¦–å…ˆï¼Œåœ¨é¡¹ç›®æ ¹ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ª vite.config.js æ–‡ä»¶ï¼Œå¹¶æ·»åŠ ä»¥ä¸‹ä»£ç ï¼š

```js
// title vite.config.js
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';

export default defineConfig({
  plugins: [react()],
});
```

æ¥ç€åˆ›å»ºä¸€ä¸ª src ç›®å½•ï¼Œå¹¶åœ¨ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ª App.jsx æ–‡ä»¶ï¼š

```jsx
// title src/App.jsx
import { useState } from 'react';

export default function App() {
  const [count, setCount] = useState(0);

  return (
    <div>
      <button onClick={() => setCount(count + 1)}>count: {count}</button>
    </div>
  );
}
```

å’Œä¸€ä¸ª entry-server.jsx æ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶æ˜¯æœåŠ¡ç«¯æ¸²æŸ“çš„å…¥å£æ–‡ä»¶ï¼š

```jsx
// title src/entry-server.jsx
import { renderToString } from 'react-dom/server';

import App from './App';

export async function render() {
  const html = renderToString(<App />);

  return { html };
}
```

æ³¨æ„ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ **renderToString** å°† React ç»„ä»¶æ¸²æŸ“æˆäº†å­—ç¬¦ä¸²ï¼Œè¿™æ˜¯å› ä¸ºåœ¨åšæœåŠ¡ç«¯æ¸²æŸ“æ—¶ï¼ŒReact ç»„ä»¶éœ€è¦è½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼Œæ‰èƒ½æ’å…¥åˆ° HTML ä¸­ï¼Œè€Œè¿™ä¸ªå°† React ç»„ä»¶è½¬æ¢ä¸º HTML å­—ç¬¦ä¸²çš„è¿‡ç¨‹ï¼Œå°±å«**è„±æ°´ï¼ˆDehydrationï¼‰**ã€‚

æ¥ç€ï¼Œä¿®æ”¹ä¸€ä¸‹ server.js æ–‡ä»¶ã€‚æˆ‘ä»¬ä»¥ä¸­é—´ä»¶çš„æ–¹å¼æ¥ä½¿ç”¨ Viteï¼Œé€šè¿‡å®ƒæ¥åŠ è½½æ‰§è¡Œ entry-server.jsx æ–‡ä»¶ï¼š

```js
// title server.js
// highlight(3,5,9:13,15,18,19,21,22)
import fs from 'node:fs/promises';
import express from 'express';
import { createServer } from 'vite';

const base = process.env.BASE || '/';

const app = express();

const vite = await createServer({
  server: { middlewareMode: true },
  appType: 'custom',
  base,
});

app.use(vite.middlewares);

app.use('*', async (req, res) => {
  const template = await fs.readFile('./index.html', 'utf-8');
  const render = (await vite.ssrLoadModule('./src/entry-server.jsx')).render;

  const renderer = await render();
  const html = template.replace('<!--app-html-->', renderer.html ?? '');

  res.status(200).set({ 'Content-Type': 'text/html' }).send(html);
});

app.listen(3000, () => {
  console.log('Server is running on http://localhost:3000');
});
```

æ³¨æ„ï¼Œæˆ‘ä»¬ä½¿ç”¨ç»„ä»¶æ¸²æŸ“æ‰€ç”Ÿæˆçš„å­—ç¬¦ä¸²æ›¿æ¢äº† HTML ä¸­çš„æ³¨é‡ŠèŠ‚ç‚¹ã€‚

ç°åœ¨ï¼Œé‡å¯ä¸€ä¸‹é¡¹ç›®ï¼Œä½ åº”è¯¥èƒ½åœ¨é¡µé¢ä¸Šçœ‹åˆ°è®¡æ•°çš„æŒ‰é’®ï¼ŒåŒæ—¶è¿”å›çš„ HTML ä¸­ä¹ŸåŒ…å«äº†ç›¸åº”çš„å†…å®¹ã€‚ä¸è¿‡æ­¤æ—¶ç‚¹å‡»æŒ‰é’®ï¼Œè®¡æ•°å¹¶ä¸ä¼šå¢åŠ ã€‚è¿™æ˜¯å› ä¸ºæˆ‘ä»¬ç›®å‰åªåœ¨æœåŠ¡ç«¯å®Œæˆäº†æ¸²æŸ“ï¼Œå®¢æˆ·ç«¯è¿˜æ²¡æœ‰è¿›è¡Œæ°´åˆã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åœ¨å®¢æˆ·ç«¯å®Œæˆæ°´åˆï¼Œå®ç°äº¤äº’ã€‚

### æ°´åˆ

é¦–å…ˆï¼Œåœ¨ src ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ª entry-client.jsx æ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶æ˜¯å®¢æˆ·ç«¯æ¸²æŸ“çš„å…¥å£æ–‡ä»¶ï¼š

```jsx
// title src/entry-client.jsx
import { hydrateRoot } from 'react-dom/client';

import App from './App';

hydrateRoot(document.getElementById('app'), <App />);
```

æ³¨æ„ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ **hydrateRoot** åœ¨å®¢æˆ·ç«¯é‡æ–°æ¸²æŸ“äº† App ç»„ä»¶ï¼Œè¿™ä¸ªè¿‡ç¨‹å…¶å®å°±æ˜¯æ°´åˆã€‚

æ°´åˆçš„è¿‡ç¨‹ä¸­éœ€è¦å°† Document ä¸­å·²æœ‰çš„ DOM å’Œ React è™šæ‹Ÿ DOM ç›¸å…³è”ï¼Œè¿™å°±è¦æ±‚ä¸¤è€…çš„ç»“æ„å¿…é¡»ä¸¥æ ¼ä¿æŒä¸€è‡´ã€‚

æ¥ç€ï¼Œæˆ‘ä»¬åœ¨ index.html ä¸­æ·»åŠ ä¸€ä¸ª script æ ‡ç­¾ï¼ŒåŠ è½½ entry-client.jsx æ–‡ä»¶ï¼š

```html
<!-- title index.html -->
<!-- highlight(9) -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Vite SSR</title>
  </head>
  <body>
    <div id="app"><!--app-html--></div>
    <script src="/src/entry-client.jsx" type="module"></script>
  </body>
</html>
```

ç„¶åï¼Œä¿®æ”¹ä¸€ä¸‹ server.js æ–‡ä»¶ï¼Œè®©å®¢æˆ·ç«¯è¯·æ±‚çš„ entry-client.jsx æ–‡ä»¶èƒ½å¤Ÿè¢« Vite å¤„ç†ï¼š

```js
// title server.js
// highlight(4,5)
app.use('*', async (req, res) => {
  const url = req.originalUrl.replace(base, '/');

  let template = await fs.readFile('./index.html', 'utf-8');
  template = await vite.transformIndexHtml(url, template);

  const render = (await vite.ssrLoadModule('./src/entry-server.jsx')).render;

  const renderer = await render();
  const html = template.replace('<!--app-html-->', renderer.html ?? '');

  res.status(200).set({ 'Content-Type': 'text/html' }).send(html);
});
```

æœ€åï¼Œé‡å¯ä¸€ä¸‹é¡¹ç›®ï¼Œå†æ¬¡ç‚¹å‡»é¡µé¢ä¸Šçš„æŒ‰é’®ï¼Œè®¡æ•°å°†ä¼šæ­£å¸¸å¢åŠ ã€‚

è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»å®Œæˆäº†ä¸€ä¸ªåŸºæœ¬çš„åŒæ„æ¸²æŸ“ã€‚ä¸‹ä¸€æ­¥ï¼Œæˆ‘ä»¬æ¥å®ç°ä¸€ä¸‹è·¯ç”±ã€‚

### è·¯ç”±

åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†åŸºäº react-router-dom å®ç°ä¸€ä¸ªæ–‡ä»¶è·¯ç”±ç³»ç»Ÿã€‚

é¦–å…ˆï¼Œå®‰è£…ä¸€ä¸‹ä¾èµ–ï¼š

```bash
pnpm add react-router-dom
```

æ¥ç€ï¼Œåœ¨ src ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ª next.jsx æ–‡ä»¶ï¼Œå¹¶å†™å…¥ä»¥ä¸‹ä»£ç ï¼š

```jsx
// title src/next.jsx
import { BrowserRouter, Route, Routes, StaticRouter } from 'react-router-dom';

export function getPageRoutes(importMap) {
  return Object.keys(importMap)
    .sort((a, b) => (a > b ? -1 : 1))
    .map((path) => ({
      path: path
        .slice(10, -4)
        .replace(/\[(\w+)\]/, (_, m) => `:${m}`)
        .replace(/\/page$/, '/'),
      component: importMap[path].default,
    }));
}

export function createRouter({ routes, url }) {
  const Router = import.meta.env.SSR ? StaticRouter : BrowserRouter;

  return (
    <Router location={url}>
      <Routes>
        {routes.map((route) => {
          const { path, component: Component } = route;
          return <Route key={path} path={path} element={<Component />} />;
        })}
      </Routes>
    </Router>
  );
}
```

createRouter å‡½æ•°ä¸­æˆ‘ä»¬ä½¿ç”¨ç¯å¢ƒå˜é‡ **import.meta.env.SSR** åˆ¤æ–­å½“å‰æ˜¯å¦ä¸ºæœåŠ¡ç«¯æ¸²æŸ“ï¼Œå¦‚æœæ˜¯æœåŠ¡ç«¯æ¸²æŸ“ï¼Œåˆ™ä½¿ç”¨ **StaticRouter** æ¥åˆ›å»ºè·¯ç”±ï¼Œå¦‚æœæ˜¯å®¢æˆ·ç«¯æ¸²æŸ“ï¼Œåˆ™ä½¿ç”¨ **BrowserRouter** æ¥åˆ›å»ºè·¯ç”±ã€‚

æ¥ç€ï¼Œåˆ›å»ºä¸€ä¸ª routes.js æ–‡ä»¶ï¼š

```js
// title src/routes.js
import { getPageRoutes } from './next';

export default getPageRoutes(import.meta.glob('/src/pages/**/page.jsx', { eager: true }));
```

æˆ‘ä»¬ä½¿ç”¨ Vite æä¾›çš„ **import.meta.glob** æ¥æ‰¹é‡å¯¼å…¥ src/pages ç›®å½•ä¸‹æ‰€æœ‰åä¸º page.jsx çš„æ–‡ä»¶ï¼Œå¹¶é€šè¿‡ getPageRoutes å‡½æ•°ç”Ÿæˆç›¸åº”çš„è·¯ç”±é…ç½®è¡¨ã€‚

å‡è®¾ä½ æœ‰ç›®å½•ç»“æ„ï¼š

```
src/pages/
â”œâ”€â”€ page.jsx
â”œâ”€â”€ about/
â”‚   â””â”€â”€ page.jsx
â””â”€â”€ contact/
    â””â”€â”€ page.jsx
```

é‚£ä¹ˆ routes.js è¿”å›çš„è·¯ç”±é…ç½®è¡¨å¦‚ä¸‹ï¼š

```js
[
  { path: '/', component: Index },
  { path: '/about/', component: About },
  { path: '/contact/', component: Contact },
];
```

æ¥ç€ï¼Œæˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹ entry-server.jsx æ–‡ä»¶ï¼Œä½¿ç”¨ createRouter å‡½æ•°æ¥åˆ›å»ºè·¯ç”±ï¼š

```jsx
// title src/entry-server.jsx
// highlight(3,4,6,7)
import { renderToString } from 'react-dom/server';

import { createRouter } from './next';
import routes from './routes';

export async function render({ url }) {
  const html = renderToString(createRouter({ routes, url }));

  return { html };
}
```

æ³¨æ„ï¼Œrender å‡½æ•°æ¥æ”¶ä¸€ä¸ªåä¸º url çš„å‚æ•°ï¼Œè¯¥å‚æ•°è¡¨ç¤ºç”¨æˆ·è®¿é—®çš„ urlã€‚

æ¥ç€ï¼Œæˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹ entry-client.jsx æ–‡ä»¶ï¼ŒåŒæ ·ä½¿ç”¨ createRouter å‡½æ•°æ¥åˆ›å»ºè·¯ç”±ï¼š

```jsx
// title src/entry-client.jsx
// highlight(3,4,6)
import { hydrateRoot } from 'react-dom/client';

import { createRouter } from './next';
import routes from './routes';

hydrateRoot(document.getElementById('app'), createRouter({ routes }));
```

æœ€åï¼Œæˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹ server.js æ–‡ä»¶ï¼Œå°† url ä½œä¸ºå‚æ•°ä¼ é€’ç»™ render å‡½æ•°ï¼š

```js
// title server.js
// highlight(9)
app.use('*', async (req, res) => {
  const url = req.originalUrl.replace(base, '/');

  let template = await fs.readFile('./index.html', 'utf-8');
  template = await vite.transformIndexHtml(url, template);

  const render = (await vite.ssrLoadModule('./src/entry-server.jsx')).render;

  const renderer = await render({ url });
  const html = template.replace('<!--app-html-->', renderer.html ?? '');

  res.status(200).set({ 'Content-Type': 'text/html' }).send(html);
});
```

æ­¤æ—¶ï¼Œä½ å°±å¯ä»¥é€šè¿‡åœ¨ src/pages ç›®å½•ä¸­åˆ›å»ºæ–‡ä»¶æ¥æ·»åŠ é¡µé¢è·¯ç”±ã€‚

ä¾‹å¦‚ï¼Œæ·»åŠ ä¸€ä¸ªæ ¹è·¯ç”±ï¼š

```jsx
// title src/pages/page.jsx
import { useState } from 'react';
import { Link } from 'react-router-dom';

export default function Index() {
  const [count, setCount] = useState(0);

  return (
    <>
      <button onClick={() => setCount(() => count + 1)}>count is {count}</button>
      <p>
        <Link to="/other">Go to another page</Link>
      </p>
    </>
  );
}
```

å’Œä¸€ä¸ª /other è·¯ç”±ï¼š

```jsx
// title src/pages/other/page.jsx
import { Link } from 'react-router-dom';

export default function Other() {
  return (
    <div>
      <p>This page is just for demonstrating client-side navigation.</p>
      <Link to="/">Go back to index</Link>
    </div>
  );
}
```

é‡å¯ä¸€ä¸‹é¡¹ç›®ï¼Œè®¿é—® [http://localhost:3000](http://localhost:3000)ï¼Œä½ åº”è¯¥èƒ½çœ‹åˆ°æ ¹è·¯ç”±é¡µé¢çš„å†…å®¹ã€‚ç‚¹å‡»é¡µé¢ä¸Šçš„é“¾æ¥ï¼Œä½ ä¼šå‘ç°é¡µé¢è¿›è¡Œçš„æ˜¯å®¢æˆ·ç«¯å¯¼èˆªï¼Œä¸ä¼šåˆ·æ–°æ•´ä¸ªé¡µé¢ã€‚

è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»å®ç°äº†ä¸€ä¸ªåŸºæœ¬çš„è·¯ç”±ç³»ç»Ÿã€‚

ä¸‹ä¸€æ­¥ï¼Œæˆ‘ä»¬æ¥å®ç°ä¸€ä¸ª getServerSideProps å‡½æ•°ï¼Œå®ç°æœåŠ¡ç«¯æ•°æ®é¢„å–ã€‚

### getServerSideProps

é¦–å…ˆï¼Œæˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹ index.html æ–‡ä»¶ï¼š

```html
<!-- title index.html -->
<!-- highlight(10) -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Vite SSR</title>
  </head>
  <body>
    <div id="app"><!--app-html--></div>
    <script src="/src/entry-client.jsx" type="module"></script>
    <!--app-data-->
  </body>
</html>
```

æˆ‘ä»¬åœ¨ HTML ä¸­æ–°åŠ å…¥äº†ä¸€ä¸ªæ³¨é‡ŠèŠ‚ç‚¹ï¼Œä¹‹åæˆ‘ä»¬ä¼šåœ¨æœåŠ¡ç«¯æ¸²æŸ“æ—¶ä½¿ç”¨æ•°æ®å†…å®¹æ¥æ›¿æ¢å®ƒã€‚

æ¥ç€ï¼Œæˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹æ ¹è·¯ç”±æ–‡ä»¶ï¼š

```jsx
// title src/pages/page.jsx
// highlight(1:5,10,19:24)
export async function getServerSideProps() {
  return {
    hobby: ['ğŸ¤', 'ğŸ’ƒ', 'ğŸ¤Ÿ', 'ğŸ€'],
  };
}

import { useState } from 'react';
import { Link } from 'react-router-dom';

export default function Index({ hobby }) {
  const [count, setCount] = useState(0);

  return (
    <>
      <button onClick={() => setCount(() => count + 1)}>count is {count}</button>
      <p>
        <Link to="/other">Go to another page</Link>
      </p>
      <p>Hobby</p>
      <ul>
        {hobby.map((item) => (
          <li key={item}>{item}</li>
        ))}
      </ul>
    </>
  );
}
```

æˆ‘ä»¬å¯¼å‡ºäº†ä¸€ä¸ª getServerSideProps å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯è·å–ç»„ä»¶æ¸²æŸ“æ‰€éœ€çš„æ•°æ®ã€‚ä¹‹åæˆ‘ä»¬ä¼šåœ¨æœåŠ¡ç«¯è°ƒç”¨å®ƒï¼Œå¹¶å°†å‡½æ•°çš„è¿”å›å€¼ä½œä¸º props ä¼ é€’ç»™ç»„ä»¶ã€‚

æ¥ç€ï¼Œä¿®æ”¹ server.js æ–‡ä»¶ï¼š

```js
// title server.js
// highlight(4:7,14,15,18:23)
app.use('*', async (req, res) => {
  const url = req.originalUrl.replace(base, '/');

  if (url === '/favicon.ico') {
    res.status(204).end();
    return;
  }

  let template = await fs.readFile('./index.html', 'utf-8');
  template = await vite.transformIndexHtml(url, template);

  const render = (await vite.ssrLoadModule('./src/entry-server.jsx')).render;

  const ctx = { serverSideProps: null };
  const renderer = await render({ url, ctx });
  const html = template.replace('<!--app-html-->', renderer.html ?? '').replace(
    '<!--app-data-->',
    ctx.serverSideProps
      ? `<script>window.__SSR_DATA__ = ${JSON.stringify({
          url,
          props: ctx.serverSideProps,
        })}</script>`
      : ''
  );

  res.status(200).set({ 'Content-Type': 'text/html' }).send(html);
});
```

åœ¨ server.js æ–‡ä»¶ä¸­æˆ‘ä»¬æ–°å¢äº†ä¸€ä¸ª ctx å¯¹è±¡ï¼Œç”¨äºå­˜å‚¨åœ¨æœåŠ¡ç«¯è·å–çš„æ•°æ®ã€‚ä¹‹åæˆ‘ä»¬å°†æ•°æ®åºåˆ—åŒ–åæ’å…¥åˆ° HTML ä¸­ã€‚è¿™æ ·åšçš„ç›®çš„æ˜¯ä¸ºäº†ç¡®ä¿å®¢æˆ·ç«¯åœ¨æ°´åˆæ—¶èƒ½åˆ©ç”¨è¿™ä»½æ•°æ®ç”Ÿæˆä¸æœåŠ¡ç«¯ä¸€è‡´çš„ DOM ç»“æ„ã€‚

ä¹Ÿè®¸æ­¤æ—¶ä½ ä¼šç–‘æƒ‘ï¼Œè¿™æ ·åšå²‚ä¸æ˜¯ä¼šå¢åŠ  HTML çš„ä½“ç§¯ï¼Ÿå°¤å…¶æ˜¯ä¸€äº›å†…å®¹å‹çš„ç½‘ç«™ï¼ŒHTML çš„ä½“ç§¯å¾ˆå¯èƒ½ä¼šæ˜¯åŒå€å¤§å°ã€‚

äº‹å®ä¸Šï¼Œçš„ç¡®æ˜¯å¦‚æ­¤ã€‚ç›®å‰è¿™ä¹Ÿæ˜¯åŒæ„æ¸²æŸ“æ™®éæ‰€é‡‡ç”¨çš„æ–¹æ¡ˆã€‚æˆ‘ä»¬åªèƒ½åšåˆ°å°½å¯èƒ½å‡å°æ’å…¥æ•°æ®çš„ä½“ç§¯ï¼Œæ— æ³•å®Œå…¨æ¶ˆé™¤ã€‚

ä¸‹ä¸€æ­¥ï¼Œæˆ‘ä»¬ä¿®æ”¹ entry-server.jsx æ–‡ä»¶ï¼š

```jsx
// title src/entry-server.jsx
// highlight(4,5,7:9,11:13,15)
import { renderToString } from 'react-dom/server';
import { matchRoutes } from 'react-router-dom';

import { createRouter } from './next';
import routes from './routes';

export async function render({ url, ctx }) {
  const [router] = matchRoutes(routes, url);
  const { getServerSideProps } = router.route;

  if (getServerSideProps) {
    ctx.serverSideProps = await getServerSideProps({ params: router.params });
  }

  const html = renderToString(createRouter({ ctx, routes, url }));

  return { html };
}
```

æˆ‘ä»¬é€šè¿‡ react-router-dom æä¾›çš„ **matchRoutes** å‡½æ•°å¯ä»¥è·å–åˆ° url å¯¹åº”çš„è·¯ç”±é…ç½®ã€‚å†ä»è·¯ç”±é…ç½®ä¸­è·å– getServerSideProps å‡½æ•°ï¼Œå¹¶è°ƒç”¨å®ƒã€‚

è°ƒç”¨ getServerSideProps å‡½æ•°è·å–åˆ°æ•°æ®åï¼Œæˆ‘ä»¬å°†æ•°æ®å­˜å‚¨åˆ° ctx å¯¹è±¡ä¸­ï¼Œå¹¶ä¸”åœ¨åˆ›å»ºè·¯ç”±æ—¶ä¼ å…¥ ctxã€‚

æ¥ç€ï¼Œæˆ‘ä»¬åœ¨ next.jsx ä¸­æ·»åŠ ä¸€ä¸ª RouteElement ç»„ä»¶ï¼š

```jsx
// title src/next.jsx
import { matchPath } from 'react-router-dom';

function RouteElement({ ctx, path, component: Component, getServerSideProps }) {
  if (ctx) {
    if (ctx.serverSideProps) {
      return <Component {...ctx.serverSideProps} />;
    } else {
      return <Component />;
    }
  }

  let { url, props: serverSideProps } = window.__SSR_DATA__ ?? {};
  window.__SSR_DATA__ = null;

  if (getServerSideProps) {
    if (serverSideProps && matchPath(path, url)) {
      return <Component {...serverSideProps} />;
    }
  }

  return <Component />;
}
```

æˆ‘ä»¬åœ¨ RouteElement ç»„ä»¶ä¸­æ ¹æ®æ˜¯å¦å­˜åœ¨ ctx å¯¹è±¡æ¥åˆ¤æ–­å½“å‰æ˜¯å¦åœ¨æœåŠ¡ç«¯æ¸²æŸ“ï¼Œå¦‚æœåœ¨æœåŠ¡ç«¯æ¸²æŸ“ï¼Œåˆ™ä» ctx ä¸­è¯»å–æ•°æ®æ¸²æŸ“ç»„ä»¶ã€‚å¦‚æœæ˜¯å®¢æˆ·ç«¯æ¸²æŸ“ï¼Œåˆ™ä» **window.\_\_SSR_DATA\_\_** ä¸­è¯»å–æ•°æ®æ¸²æŸ“ç»„ä»¶ã€‚

å®¢æˆ·ç«¯æ¸²æŸ“æ—¶æˆ‘ä»¬è¿˜ä½¿ç”¨äº† **matchPath** å‡½æ•°æ¥åˆ¤æ–­ url æ˜¯å¦èƒ½ä¸è·¯ç”± path åŒ¹é…ï¼Œè¿™ä¹ˆåšçš„ç›®çš„æ˜¯ä¸ºäº†ä¿è¯æ•°æ®èƒ½æ­£ç¡®çš„ä¼ é€’ç»™å¯¹åº”çš„è·¯ç”±ã€‚

æ¥ç€ï¼Œæˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹ createRouter å‡½æ•°ï¼Œå°† RouteElement ç»„ä»¶ä½œä¸ºè·¯ç”±çš„å…ƒç´ ï¼š

```jsx
// title src/next.jsx
// highlight(9)
export function createRouter({ ctx, routes, url }) {
  const Router = import.meta.env.SSR ? StaticRouter : BrowserRouter;

  return (
    <Router location={url}>
      <Routes>
        {routes.map((route) => {
          const { path } = route;
          return <Route key={path} path={path} element={<RouteElement ctx={ctx} {...route} />} />;
        })}
      </Routes>
    </Router>
  );
}
```

æœ€åï¼Œé‡å¯ä¸€ä¸‹é¡¹ç›®ï¼Œä½ åº”è¯¥èƒ½å¤Ÿçœ‹åˆ°åœ¨æ ¹è·¯ç”±é¡µé¢ä¸­æ˜¾ç¤ºäº† Hobby åˆ—è¡¨ã€‚

### å®¢æˆ·ç«¯çš„ getServerSideProps

æˆ‘ä»¬ç›®å‰å·²ç»å®ç°äº†é¦–å±æ¸²æŸ“æ—¶ï¼Œåœ¨æœåŠ¡ç«¯è°ƒç”¨ getServerSideProps å‡½æ•°æ¥è·å–æ•°æ®ã€‚ä½†æˆ‘ä»¬è¿˜æœ‰æ²¡å®ç°ï¼Œåœ¨å®¢æˆ·ç«¯æ¸²æŸ“æ—¶è°ƒç”¨ getServerSideProps å‡½æ•°æ¥è·å–æ•°æ®ã€‚

ä¾‹å¦‚ï¼Œæˆ‘ä»¬åœ¨ /other è·¯ç”±ä¸­æ·»åŠ ä¸€ä¸ª getServerSideProps å‡½æ•°ï¼š

```jsx
// title src/pages/other/page.jsx
// highlight(1:5,7,10)
export async function getServerSideProps() {
  return {
    title: 'Other',
  };
}

export default function Other({ title }) {
  return (
    <div>
      <h1>{title}</h1>
      <p>This page is just for demonstrating client-side navigation.</p>
      <Link to="/">Go back to index</Link>
    </div>
  );
}
```

æˆ‘ä»¬ä»é¦–å±æ¸²æŸ“çš„æ ¹è·¯ç”±é€šè¿‡é“¾æ¥è¿›å…¥åˆ° /otherï¼Œä½ ä¼šå‘ç°é¡µé¢ä¸­æ²¡æœ‰æ˜¾ç¤º title å†…å®¹ã€‚

é€šå¸¸æƒ…å†µä¸‹ï¼Œå®¢æˆ·ç«¯æ¸²æŸ“ä¸èƒ½ç›´æ¥è°ƒç”¨ getServerSideProps å‡½æ•°æ¥è·å–æ•°æ®ï¼Œè¯¥å‡½æ•°åº”å§‹ç»ˆåœ¨æœåŠ¡ç«¯è¿è¡Œã€‚å¸¸è§çš„å¤„ç†æ–¹å¼æ˜¯ç”±å®¢æˆ·ç«¯å‘é€è¯·æ±‚åˆ°æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯è°ƒç”¨ getServerSideProps å‡½æ•°è·å–æ•°æ®åå†è¿”å›ç»™å®¢æˆ·ç«¯ã€‚

åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä¸åšè¿™ç§å¤æ‚çš„å¤„ç†ï¼Œç›´æ¥åœ¨å®¢æˆ·ç«¯è°ƒç”¨ getServerSideProps å‡½æ•°æ¥è·å–æ•°æ®ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹ entry-client.jsx æ–‡ä»¶ï¼Œå°† createRouter å‡½æ•°åŒ…è£¹åœ¨ Suspense ç»„ä»¶ä¸­ï¼š

```jsx
// title src/entry-client.jsx
// highlight(1,7)
import { Suspense } from 'react';
import { hydrateRoot } from 'react-dom/client';

import { createRouter } from './next';
import routes from './routes';

hydrateRoot(document.getElementById('app'), <Suspense>{createRouter({ routes })}</Suspense>);
```

åŒæ ·ï¼Œåœ¨ entry-server.jsx æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿå°† createRouter å‡½æ•°åŒ…è£¹åœ¨ Suspense ç»„ä»¶ä¸­ï¼š

```jsx
// title src/entry-server.jsx
// highlight(1,16)
import { Suspense } from 'react';
import { renderToString } from 'react-dom/server';
import { matchRoutes } from 'react-router-dom';

import routes from './routes';
import { createRouter } from './next';

export async function render({ ctx, url }) {
  const [router] = matchRoutes(routes, url);
  const { getServerSideProps } = router.route;

  if (getServerSideProps) {
    ctx.serverSideProps = await getServerSideProps({ params: router.params });
  }

  const html = renderToString(<Suspense>{createRouter({ ctx, routes, url })}</Suspense>);

  return { html };
}
```

æ¥ç€ï¼Œæˆ‘ä»¬åœ¨ next.jsx æ–‡ä»¶ä¸­æ·»åŠ ä¸€ä¸ª fetchWithSuspense å‡½æ•°ï¼š

```jsx
// title src/next.jsx
const activeLoaderMap = new Map();

function fetchWithSuspense({ fetchKey, fetchFn, fetchParams }) {
  let loader;

  if ((loader = activeLoaderMap.get(fetchKey))) {
    if (loader.error || loader.data?.statusCode === 500) {
      if (loader.data?.statusCode === 500) {
        throw new Error(loader.data.message);
      }
      throw loader.error;
    }

    if (loader.suspended) {
      throw loader.promise;
    }

    activeLoaderMap.delete(fetchKey);

    return loader.data;
  } else {
    loader = {
      suspended: true,
      error: null,
      data: null,
      promise: null,
    };

    loader.promise = Promise.resolve(fetchFn(fetchParams))
      .then((data) => (loader.data = data))
      .catch((error) => (loader.error = error))
      .finally(() => (loader.suspended = false));

    activeLoaderMap.set(fetchKey, loader);

    return fetchWithSuspense({ fetchKey, fetchFn, fetchParams });
  }
}
```

fetchWithSuspense å‡½æ•°ä¼šæŠŠä¸€ä¸ª promise å®ä¾‹åšä¸ºå¼‚å¸¸æŠ›å‡ºï¼Œè¿™æ ·åšçš„ç›®çš„æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ

æˆ‘ä»¬å…ˆç»§ç»­ä¿®æ”¹ä»£ç ï¼Œåœ¨ RouteElement ç»„ä»¶ä¸­æˆ‘ä»¬é€šè¿‡ fetchWithSuspense å‡½æ•°æ¥è°ƒç”¨ getServerSideProps å‡½æ•°è·å–æ•°æ®ï¼š

```jsx
// title src/next.jsx
// highlight(1,20,22:34)
import { useParams } from 'react-router-dom';

function RouteElement({ ctx, path, component: Component, getServerSideProps }) {
  if (ctx) {
    if (ctx.serverSideProps) {
      return <Component {...ctx.serverSideProps} />;
    } else {
      return <Component />;
    }
  }

  let { url, props: serverSideProps } = window.__SSR_DATA__ ?? {};
  window.__SSR_DATA__ = null;

  if (getServerSideProps) {
    if (serverSideProps && matchPath(path, url)) {
      return <Component {...serverSideProps} />;
    }

    const params = useParams();

    try {
      serverSideProps = fetchWithSuspense({
        fetchKey: path,
        fetchFn: getServerSideProps,
        fetchParams: { params },
      });
      return <Component {...serverSideProps} />;
    } catch (error) {
      if (error instanceof Error) {
        return <p>Error: {error.message}</p>;
      }
      throw error;
    }
  }

  return <Component />;
}
```

å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬åœ¨æ¸²æŸ“è·¯ç”±æ—¶æ•è·äº† fetchWithSuspense å‡½æ•°æŠ›å‡ºçš„ promiseï¼Œå¹¶å°†å…¶ç»§ç»­å‘ä¸Šä¼ é€’ã€‚æœ€é¡¶å±‚çš„ Suspense ç»„ä»¶ä¼šæ•è·è¿™ä¸ª promiseï¼Œå¹¶åœ¨ promise è§£å†³åè‡ªåŠ¨é‡æ–°æ¸²æŸ“å…¶å­ç»„ä»¶ã€‚

åŒæ—¶ï¼Œ react-router-dom åœ¨æ¸²æŸ“æ–°çš„è·¯ç”±æ—¶ï¼Œå¦‚æœå‘ç”Ÿé”™è¯¯ï¼Œåˆ™ä¼šåœç•™åœ¨æ—§çš„è·¯ç”±ã€‚è€Œå› ä¸º Suspense ç»„ä»¶çš„å­˜åœ¨ï¼Œæ‰€ä»¥åœ¨ promise è¢«è§£å†³åï¼Œreact-router-dom ä¹Ÿä¼šé‡æ–°æ¸²æŸ“æ–°çš„è·¯ç”±å¹¶ä¸”ä¸ä¼šå†é‡åˆ°é”™è¯¯ã€‚

åˆ©ç”¨è¿™äº›ç‰¹ç‚¹ï¼Œæˆ‘ä»¬å°±å¯ä»¥åšåˆ°å®¢æˆ·ç«¯ä½¿ç”¨ getServerSideProps è·å–åˆ°ä¸‹ä¸ªè·¯ç”±çš„æ•°æ®å‰ï¼Œå°†é¡µé¢è§†å›¾åœç•™åœ¨å½“å‰è·¯ç”±ã€‚

é‡å¯ä¸€ä¸‹é¡¹ç›®ï¼Œå†æ¬¡è®¿é—® /other è·¯ç”±ï¼Œæ­¤æ—¶ä½ åº”è¯¥å°±èƒ½çœ‹åˆ° title å†…å®¹äº†ã€‚

è‡³æ­¤ï¼Œæˆ‘ä»¬å°±å®ç°äº†ä¸€ä¸ªåŸºæœ¬å®Œæ•´çš„åŒæ„æ¸²æŸ“æµç¨‹ã€‚
